---
description: Quy táº¯c báº¯t buá»™c cho mÃ´i trÆ°á»ng Docker - LUÃ”N cháº¡y commands trong container
globs: ["**/*"]
alwaysApply: true
---

# âš ï¸ QUY Táº®C QUAN TRá»ŒNG NHáº¤T

á»¨ng dá»¥ng Rails nÃ y Ä‘ang cháº¡y hoÃ n toÃ n trong Docker containers. **TUYá»†T Äá»I KHÃ”NG** cháº¡y báº¥t ká»³ lá»‡nh Rails, Ruby, Bundle, Database, hoáº·c npm trá»±c tiáº¿p trÃªn host machine.

# ğŸ³ Cáº¥u trÃºc Docker Services

## Services Ä‘ang cháº¡y:
- **web**: Rails application (port 3000)
  - Image: Dockerfile.dev (Ruby 3.4.2)
  - Working directory: /app
  - Volumes: code sync tá»« host vÃ o /app

- **db**: MySQL 8.0 database
  - Database: sample_prompt_ai_cursor_development
  - User: rails_user
  - Password: password
  - Port: 3306

- **test_db**: MySQL 8.0 cho testing
  - Database: sample_prompt_ai_cursor_test

## Volumes:
- `.` â†’ `/app` (code sync)
- `bundle_cache` â†’ `/usr/local/bundle` (gems cache)

# ğŸ“‹ Commands - LUÃ”N sá»­ dá»¥ng docker compose exec

## Quáº£n lÃ½ Containers
```bash
# Start táº¥t cáº£ services
docker compose up -d

# Stop táº¥t cáº£ services
docker compose down

# Xem logs
docker compose logs -f web
docker compose logs -f db

# Rebuild containers (khi thay Ä‘á»•i Dockerfile)
docker compose build
docker compose up -d --build

# Restart má»™t service
docker compose restart web
docker compose restart db

# Xem status
docker compose ps

# XÃ³a táº¥t cáº£ (bao gá»“m volumes - Cáº¨N THáº¬N!)
docker compose down -v
```

## Bundle / Gems Management
```bash
# Install gems (sau khi thÃªm gem vÃ o Gemfile)
docker compose exec web bundle install

# Update gems
docker compose exec web bundle update

# Check gem version
docker compose exec web bundle list | grep <gem_name>

# Bundle audit
docker compose exec web bundle exec brakeman
```

## Rails Commands
```bash
# Rails console
docker compose exec web rails console
docker compose exec web rails c

# Rails server (thÆ°á»ng Ä‘Ã£ cháº¡y tá»± Ä‘á»™ng)
docker compose exec web rails server -b 0.0.0.0

# Generate
docker compose exec web rails generate model User name:string email:string
docker compose exec web rails generate controller Users index show
docker compose exec web rails generate migration AddAgeToUsers age:integer

# Routes
docker compose exec web rails routes
docker compose exec web rails routes | grep user

# Rails tasks
docker compose exec web rails -T
docker compose exec web rails about
```

## Database Commands
```bash
# Create database
docker compose exec web rails db:create

# Run migrations
docker compose exec web rails db:migrate

# Rollback migration
docker compose exec web rails db:rollback
docker compose exec web rails db:rollback STEP=2

# Reset database (DROP + CREATE + MIGRATE + SEED)
docker compose exec web rails db:reset

# Drop database
docker compose exec web rails db:drop

# Seed data
docker compose exec web rails db:seed

# Database status
docker compose exec web rails db:version

# MySQL console
docker compose exec db mysql -u rails_user -ppassword sample_prompt_ai_cursor_development

# MySQL dump
docker compose exec db mysqldump -u rails_user -ppassword sample_prompt_ai_cursor_development > backup.sql
```

## Testing
```bash
# Cháº¡y táº¥t cáº£ tests
docker compose exec web rails test

# Cháº¡y má»™t test file cá»¥ thá»ƒ
docker compose exec web rails test test/models/user_test.rb

# Cháº¡y má»™t test method cá»¥ thá»ƒ (thÃªm line number)
docker compose exec web rails test test/models/user_test.rb:10

# Cháº¡y system tests
docker compose exec web rails test:system

# Cháº¡y tests theo category
docker compose exec web rails test:models
docker compose exec web rails test:controllers
docker compose exec web rails test:integration

# Test vá»›i verbose
docker compose exec web rails test -v

# Rubocop
docker compose exec web rubocop
docker compose exec web rubocop -a  # auto-correct
```

## Assets & Frontend
```bash
# Precompile assets (náº¿u cáº§n)
docker compose exec web rails assets:precompile

# Clear assets
docker compose exec web rails assets:clobber

# Importmap commands
docker compose exec web rails importmap:install
docker compose exec web rails importmap:audit
```

## Interactive Shell
```bash
# Bash shell trong web container
docker compose exec web bash

# Bash shell trong db container
docker compose exec db bash

# IRB
docker compose exec web irb

# Cháº¡y script Ruby
docker compose exec web ruby script.rb
```

## Debugging
```bash
# Check container status
docker compose ps

# Check logs with tail
docker compose logs --tail=100 web

# Follow logs real-time
docker compose logs -f web

# Check processes trong container
docker compose exec web ps aux

# Check disk usage
docker compose exec web df -h

# Environment variables
docker compose exec web env
```

# ğŸ”„ Workflow thÃ´ng dá»¥ng

## Khi thÃªm gem má»›i:
1. ThÃªm gem vÃ o `Gemfile` (edit trÃªn host machine)
2. `docker compose exec web bundle install`
3. `docker compose restart web` (náº¿u cáº§n)

## Khi táº¡o migration:
1. `docker compose exec web rails generate migration CreateUsers`
2. Edit migration file (trÃªn host machine)
3. `docker compose exec web rails db:migrate`

## Khi táº¡o model má»›i:
1. `docker compose exec web rails generate model User name:string email:string`
2. `docker compose exec web rails db:migrate`
3. Viáº¿t tests vÃ  code

## Khi gáº·p lá»—i database:
1. `docker compose exec web rails db:drop`
2. `docker compose exec web rails db:create`
3. `docker compose exec web rails db:migrate`
4. `docker compose exec web rails db:seed`

# âŒ TUYá»†T Äá»I KHÃ”NG lÃ m

```bash
# âŒ KHÃ”NG cháº¡y trá»±c tiáº¿p trÃªn host
bundle install          # SAI!
rails console          # SAI!
rails db:migrate       # SAI!
rails generate model   # SAI!
mysql -u root          # SAI!

# âœ… ÄÃšNG - LuÃ´n dÃ¹ng docker compose exec web
docker compose exec web bundle install
docker compose exec web rails console
docker compose exec web rails db:migrate
docker compose exec web rails generate model User
docker compose exec db mysql -u rails_user -ppassword
```

# ğŸ“ LÆ°u Ã½ quan trá»ng

1. **Code sync tá»± Ä‘á»™ng**: Má»i thay Ä‘á»•i file trÃªn host sáº½ tá»± Ä‘á»™ng sync vÃ o container
2. **Gems cache**: Gems Ä‘Æ°á»£c cache trong volume, khÃ´ng cáº§n install láº¡i khi restart
3. **Database persistence**: Data trong database Ä‘Æ°á»£c lÆ°u trong volume
4. **Port mapping**: Rails cháº¡y trÃªn localhost:3000 tá»« host machine
5. **Hot reload**: Rails tá»± Ä‘á»™ng reload code khi file thay Ä‘á»•i (development mode)

# ğŸ› Troubleshooting

## Container khÃ´ng start:
```bash
docker compose down
docker compose build
docker compose up -d
```

## Database connection error:
```bash
# Äá»£i database ready
docker compose exec web rails db:create
```

## Permission errors:
```bash
docker compose exec web chmod +x bin/rails
docker compose exec web chmod +x bin/setup
```

## Reset toÃ n bá»™:
```bash
docker compose down -v  # XÃ“A cáº£ volumes!
docker compose build
docker compose up -d
docker compose exec web rails db:setup
```
